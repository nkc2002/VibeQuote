# VibeQuote CI/CD Pipeline
# Runs on push to main: lint, test, build FE & BE, check bundle size, deploy

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  # ============================================================
  # Lint & Test
  # ============================================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run tests
        run: npm test
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}

  # ============================================================
  # Build Frontend (React/Vite)
  # ============================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 7

  # ============================================================
  # Build Backend (Express)
  # ============================================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compile check (server)
        run: npx tsc --noEmit -p tsconfig.node.json

      - name: Create server bundle
        run: |
          mkdir -p server-bundle
          cp -r server/ server-bundle/
          cp -r shared/ server-bundle/
          cp package.json server-bundle/
          cp package-lock.json server-bundle/
          cp tsconfig.node.json server-bundle/

          # Install production dependencies only
          cd server-bundle
          npm ci --omit=dev

          # Create zip for size check
          cd ..
          zip -r server-bundle.zip server-bundle/

      - name: Check bundle size
        id: size-check
        run: |
          SIZE=$(stat -f%z server-bundle.zip 2>/dev/null || stat -c%s server-bundle.zip)
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Bundle size: ${SIZE_MB}MB"
          echo "size_mb=${SIZE_MB}" >> $GITHUB_OUTPUT

          if [ $SIZE_MB -gt 50 ]; then
            echo "❌ ERROR: Server bundle exceeds 50MB limit (${SIZE_MB}MB)"
            echo ""
            echo "=== RECOMMENDED FIXES ==="
            echo "1. Move large dependencies to external services (e.g., FFmpeg URL download)"
            echo "2. Use npm ci --omit=dev to exclude dev dependencies"
            echo "3. Add heavy packages to .npmignore or exclude from bundle"
            echo "4. Consider splitting into microservices"
            echo "5. Use dynamic imports for optional features"
            echo ""
            echo "=== LARGEST PACKAGES ==="
            du -sh server-bundle/node_modules/* 2>/dev/null | sort -rh | head -20
            exit 1
          fi

          echo "✅ Bundle size OK: ${SIZE_MB}MB (limit: 50MB)"

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-bundle
          path: server-bundle.zip
          retention-days: 7

  # ============================================================
  # Upload FFmpeg Binary (Optional)
  # ============================================================
  upload-ffmpeg:
    name: Upload FFmpeg
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.UPLOAD_FFMPEG == 'true'
    needs: [build-frontend, build-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download FFmpeg static build
        run: |
          # Download minimal FFmpeg static build for Linux
          curl -L -o ffmpeg.tar.xz https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
          tar -xf ffmpeg.tar.xz
          mv ffmpeg-*-amd64-static/ffmpeg ./ffmpeg
          chmod +x ffmpeg

          # Create minimal package
          tar -czf ffmpeg-linux-amd64.tar.gz ffmpeg

          echo "FFmpeg binary size: $(du -h ffmpeg | cut -f1)"

      - name: Upload to S3 (if configured)
        if: env.AWS_ACCESS_KEY_ID != ''
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_REGION: ${{ secrets.S3_REGION || 'us-east-1' }}
        run: |
          aws s3 cp ffmpeg-linux-amd64.tar.gz s3://${S3_BUCKET}/binaries/ffmpeg-linux-amd64.tar.gz
          FFMPEG_URL="https://${S3_BUCKET}.s3.${S3_REGION}.amazonaws.com/binaries/ffmpeg-linux-amd64.tar.gz"
          echo "✅ FFmpeg uploaded to: ${FFMPEG_URL}"
          echo "Set FFMPEG_URL=${FFMPEG_URL} in your deployment environment"

      - name: Create GitHub Release (if no S3)
        if: env.AWS_ACCESS_KEY_ID == ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ffmpeg-v1.0.${{ github.run_number }}
          name: FFmpeg Binary v1.0.${{ github.run_number }}
          files: ffmpeg-linux-amd64.tar.gz
          body: |
            Minimal FFmpeg binary for video generation.

            Set in your deployment:
            ```
            FFMPEG_URL=https://github.com/${{ github.repository }}/releases/download/ffmpeg-v1.0.${{ github.run_number }}/ffmpeg-linux-amd64.tar.gz
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Deploy to Render (or other host)
  # ============================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-frontend, build-backend]
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Download server artifact
        uses: actions/download-artifact@v4
        with:
          name: server-bundle
          path: ./

      # Option 1: Deploy to Render
      - name: Deploy to Render
        if: env.RENDER_DEPLOY_HOOK != ''
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          curl -X POST "$RENDER_DEPLOY_HOOK"
          echo "✅ Triggered Render deployment"

      # Option 2: Deploy to Railway
      - name: Deploy to Railway
        if: env.RAILWAY_TOKEN != ''
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          npm install -g @railway/cli
          railway up --detach
          echo "✅ Deployed to Railway"

      # Option 3: Deploy to Fly.io
      - name: Deploy to Fly.io
        if: env.FLY_API_TOKEN != ''
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          curl -L https://fly.io/install.sh | sh
          ~/.fly/bin/flyctl deploy --remote-only
          echo "✅ Deployed to Fly.io"

      # Output deployment status
      - name: Deployment Summary
        run: |
          echo "==================================="
          echo "      DEPLOYMENT COMPLETE         "
          echo "==================================="
          echo ""
          echo "Frontend: Built and ready"
          echo "Backend: Built and deployed"
          echo ""
          echo "If no deploy hook triggered, set one of:"
          echo "  - RENDER_DEPLOY_HOOK"
          echo "  - RAILWAY_TOKEN"  
          echo "  - FLY_API_TOKEN"
